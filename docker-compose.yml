version: '3.8'

services:
  # Main FocusVault extension development and testing environment
  focusvault-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: focusvault-dev
    ports:
      - "3000:3000"        # HTTP server for extension testing
      - "3001:3001"        # API proxy
      - "8000:8000"        # Alternative HTTP server port
    environment:
      - NODE_ENV=development
      - GROQ_API_URL=https://api.groq.com
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    volumes:
      - .:/app             # Mount entire project for live reload
      - /app/node_modules  # Prevent node_modules from being overwritten
    restart: unless-stopped
    networks:
      - focusvault-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    stdin_open: true
    tty: true

  # Optional: Groq API proxy service for local development
  groq-proxy:
    image: node:18-alpine
    container_name: focusvault-groq-proxy
    working_dir: /proxy
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    ports:
      - "3001:3001"
    volumes:
      - ./proxy:/proxy:ro
    command: >
      sh -c "if [ -d /proxy ]; then 
             npm install express cors --no-save 2>/dev/null || true && 
             node /proxy/server.js; 
             else 
             echo 'Proxy directory not found. Skipping proxy service.'; 
             fi"
    restart: unless-stopped
    networks:
      - focusvault-network
    depends_on:
      - focusvault-dev
    profiles:
      - with-proxy

networks:
  focusvault-network:
    driver: bridge
    name: focusvault-network

volumes:
  app-data:
    driver: local
